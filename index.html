<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸ“¡</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“º</text></svg>">

  <link rel="stylesheet" href="style.css">
  <script src="githubPagesLocalStorage.js"></script>
  <script src="clock.js"></script>
</head>

<body>
  <div id="player"></div>
  
  <div id="dark"></div>
  <div id="click-catcher"></div>

  <div id="channels">
    <div class="channel">
      <img src="logos/BTV.png" draggable="false" />
    </div>
  </div>

  <video id="movie-player" style="position: absolute; width: 100%; height: 100%; display: none;"></video>

  <div id="speech-recognition" style="position: absolute; display: none;">
    <button id="startButton">Start</button>
    <div id="output" style="color: white">...</div>
  </div>

  <script>

    // todo
    // - Selon la playlist aller Ã  la vidÃ©o suivante ou une vidÃ©o alÃ©atoire
    // - Selon la playlist reprendre lÃ  ou en en Ã©tait ou pas (tv live)
    // - GÃ©rer les vidÃ©os qui n'existent plus -> gÃ©nÃ¨re une erreur

    let lastPlaylistData = JSON.parse(localStorage.getItem('lastPlaylistData')) || {};
    let lastMovieData = {}; // Stockage de la progression des films
    let saveInterval = null; // Pour stocker le timer de sauvegarde
    let darkDivOpacity = 0;
    let isLocalMovieMode = false; // Flag pour le mode film local
    let currentMovie = null; // Fichier film actuellement en lecture
    
    // List of local movies (default fallback)
    var movies = [
      'file_example_MP4_480_1_5MG.mp4'
    ];
    
    function initData() {
      // Charger les donnÃ©es YouTube
      fetch('http://localhost:5000/load')
          .then(response => response.json())
          .then(data => {
              console.log("Sauvegarde chargÃ©e du serveur:", data);
              lastPlaylistData = data;
          })
          .catch(err => console.error("Erreur chargement:", err));
      
      // Charger les donnÃ©es des films
      fetch('http://localhost:5000/movies-progress')
          .then(response => response.json())
          .then(data => {
              console.log("Progression films chargÃ©e du serveur:", data);
              lastMovieData = data;
          })
          .catch(err => console.error("Erreur chargement films:", err));
      
      // Charger la liste des fichiers films disponibles
      fetch('http://localhost:5000/movies-list')
          .then(response => response.json())
          .then(data => {
              if (data && data.length > 0) {
                  console.log("Liste des films chargÃ©e:", data);
                  movies = data;
              }
          })
          .catch(err => console.error("Erreur chargement liste films:", err));
    }

    initData();

    // Function to save the last viewed video id and current time for a playlist to session storage
    function saveCurrentPlaylistDataToLocalStorage() {
        // 1. Mise Ã  jour de la variable JS
        if (!player || !player.getPlaylistId()) return;
        
        lastPlaylistData[player.getPlaylistId()] = {
            videoId: player.getVideoData().video_id,
            videoIndex: player.getPlaylistIndex(),
            currentTime: player.getCurrentTime()
        };

        // 2. Envoi au serveur Python (API)
        fetch('http://localhost:5000/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(lastPlaylistData)
        }).catch(err => console.warn("Erreur sauvegarde:", err));
    }

    // Function to save the current movie progress
    function saveMovieProgress() {
        if (!currentMovie) return;

        // 1. Mise Ã  jour de la variable JS
        lastMovieData[currentMovie] = {
            currentTime: moviePlayer.currentTime
        };

        // 2. Envoi au serveur Python (API)
        fetch('http://localhost:5000/movies-progress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(lastMovieData)
        }).catch(err => console.warn("Erreur sauvegarde film:", err));
    }

    // Function to get the last viewed video id and current time for a playlist
    function getLastPlaylistData(playlist) {
      return lastPlaylistData[playlist] || {videoId: '', videoIndex: 0, currentTime: 0};
    }

    // Function to get the last movie progress
    function getLastMovieData(filename) {
      return lastMovieData[filename] || {currentTime: 0};
    }

    let cursorHideTimeout;

    function hideCursor() {
      document.body.style.cursor = 'none';
    }

    function showCursor() {
      document.body.style.cursor = 'auto';
      clearTimeout(cursorHideTimeout);
      cursorHideTimeout = setTimeout(hideCursor, 3000);
    }

    document.addEventListener('mousemove', showCursor);
    document.addEventListener('mousedown', showCursor);

    // Initialize cursor hide on page load
    showCursor();

    // Load the YouTube IFrame Player API code asynchronously.
    var tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    tag.onError = onError;

    var playlists = [
      //{id: 'PLJk4PP_cLUVQ29v7o1hI6w0FFjRaLGt40', logo: 'MovieTV.png'}, //  peplum
      {id: 'PLy1pnOysMn9LkcL89omeqd79FH7K3zitw', logo: 'newsTV.png'}, // 1 news
      {id: 'PLmNJItE2MCubz0ibr5tB07Hp4NCZWztWL', logo: 'dunkTV.png'}, // 2 basket
      {id: 'PLI-KORiB_eLzez0JL6CR_XadP-Nm8XfJA', logo: 'DisneyTV.png'}, // 3 disney
      {id: 'PL0dRZjWdHde0R7UQLzNo64bHaFtvmw4wC', logo: 'Making of TV.png'}, // 4 making of
      {id: 'PLg6bQuWdqr_YpnEkOrJdh3ZVSiY6suben', logo: 'BTV.png'}, // 5 billiard

      {id: 'PLy1pnOysMn9JrrVsp1kk6RHK_UHxQKAJi', logo: 'WakeUpTV.png'}, // 6 wake up
      {id: 'PLy1pnOysMn9JVLeoL1QrV4aSEdujD4ESV', logo: 'SleepTV.jpg'}, // 7 sleep
      {id: 'PLy1pnOysMn9JVLeoL1QrV4aSEdujD4ESV', logo: 'SleepTV.jpg'}, // 8 sleep
      {id: 'PLy1pnOysMn9JVLeoL1QrV4aSEdujD4ESV', logo: 'SleepTV.jpg'}, // 9 local movies
    ];

    // This function creates an <iframe> (and YouTube player)
    // after the API code downloads.
    var player;

    function disableYouTubeControls() {
      // Disable YouTube player keyboard shortcuts when in movie mode
      if (player && typeof player.setOption === 'function') {
        player.setOption('controls', 0); // Hide controls
      }
      // Remove focus from YouTube iframe to prevent it from intercepting keys
      var iframe = document.querySelector('iframe');
      if (iframe) {
        iframe.style.pointerEvents = 'none';
      }
    }

    function enableYouTubeControls() {
      // Re-enable YouTube player controls when back in YouTube mode
      if (player && typeof player.setOption === 'function') {
        player.setOption('controls', 1); // Show controls
      }
      // Re-enable YouTube iframe interaction
      var iframe = document.querySelector('iframe');
      if (iframe) {
        iframe.style.pointerEvents = 'auto';
      }
    }

    function onYouTubeIframeAPIReady() {
      console.info('onYouTubeIframeAPIReady')
      player = new YT.Player('player', {
        height: '300',
        width: '400',
        videoId: '3zyOHgkEaO8', // 5mGuCdlCcNM
        playerVars: {

          'autoplay': 1, // Autoplay the video
          'controls': 1, // Show player controls
          'loop': 1, // Enable loop
          'modestbranding': 1,

          'color': 'white',
          'iv_load_policy': 3,
          'rel': 0
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange,
          'onError': onError
        }
      });
    }

    // Function to handle errors when loading the YouTube API
    function onError(event) {
      console.log('Error loading the YouTube API', event);
    }

    // The API will call this function when the video player is ready.
    function onPlayerReady(event) {
      console.info('onPlayerReady', event)
      event.target.playVideo();
      event.target.setPlaybackQuality('hd720');
      document.body.focus();
      startChannelsSelectorListening()
    }

    function onPlayerStateChange(event) {
      console.info('onPlayerStateChange', event)

      // Ignore YouTube player state changes when in local movie mode
      if (isLocalMovieMode) {
        // Force YouTube to stay paused when in movie mode
        if (player && typeof player.pauseVideo === 'function') {
          player.pauseVideo();
        }
        return;
      }

      if (event.data == YT.PlayerState.PLAYING) {
        if (!saveInterval) saveInterval = setInterval(saveCurrentPlaylistDataToLocalStorage, 2500);
      } else {
        if (saveInterval) {
            clearInterval(saveInterval);
            saveInterval = null;
        }
      }

      if (event.data == YT.PlayerState.ENDED) player.playVideo(); // When the video ends, play the next video

      if (event.data == YT.PlayerState.BUFFERING) player.setPlaybackQuality('hd720');

      document.body.focus();
    }

    document.addEventListener('keydown', function (event) {
      console.info(event.key)
      var k = event.key
      var volumeInc = player.getVolume() <= 10 ? 1 : 5;
      
      if (k === 'AudioVolumeMute' || k === 'a') {
        if (isLocalMovieMode) {
          moviePlayer.pause();
        } else {
          player.pauseVideo();
          setTvPower(false);
        }
      }
      
      if (k === 'AudioVolumeUp') {
        if (isLocalMovieMode) {
          var newVol = Math.min(100, moviePlayer.volume * 100 + volumeInc);
          moviePlayer.volume = newVol / 100;
        } else {
          player.setVolume(player.getVolume() + volumeInc);
        }
      }
      
      if (k === 'AudioVolumeDown') {
        if (isLocalMovieMode) {
          var newVol = Math.max(0, moviePlayer.volume * 100 - volumeInc);
          moviePlayer.volume = newVol / 100;
        } else {
          player.setVolume(player.getVolume() - volumeInc);
        }
      }
      
      if (k === 'ArrowRight') {
        if (isLocalMovieMode) {
          moviePlayer.currentTime += 15;
        } else {
          player.seekTo(player.getCurrentTime() + 15, true);
        }
      }
      
      if (k === 'ArrowLeft') {
        if (isLocalMovieMode) {
          moviePlayer.currentTime = Math.max(0, moviePlayer.currentTime - 15);
        } else {
          player.seekTo(player.getCurrentTime() - 15, true);
        }
      }
      
      if (k === 'MediaTrackNext') {
        if (isLocalMovieMode) {
          var currentIndex = movies.indexOf(currentMovie);
          if (currentIndex < movies.length - 1) {
            playMovieAtIndex(currentIndex + 1);
          }
        } else {
          player.nextVideo();
        }
      }
      
      if (k === 'MediaTrackPrevious') {
        if (isLocalMovieMode) {
          var currentIndex = movies.indexOf(currentMovie);
          if (currentIndex > 0) {
            playMovieAtIndex(currentIndex - 1);
          }
        } else {
          player.previousVideo();
        }
      }
      
      if (k === 'MediaPlayPause' || k === 'p') {
        if (isLocalMovieMode) {
          if (moviePlayer.paused) {
            moviePlayer.play();
            document.documentElement.requestFullscreen();
            setTvPower(true);
            // Ensure YouTube stays paused
            if (player && typeof player.pauseVideo === 'function') {
              player.pauseVideo();
            }
          } else {
            moviePlayer.pause();
          }
        } else {
          if (player.getPlayerState() === 2) {
            player.playVideo();
            document.documentElement.requestFullscreen();
            setTvPower(true);
          } else {
            player.pauseVideo();
          }
        }
      }
    });

    document.addEventListener('keydown', function (event) {
      if (event.key !== 'PageUp' && event.key !== 'PageDown') return;

      //var darkDiv = document.getElementById('dark');
      //var currentOpacity = parseFloat(window.getComputedStyle(darkDiv).getPropertyValue('opacity'));
      darkDivOpacity += (event.key === 'PageUp' ? -0.05 : 0.05);
      darkDivOpacity = darkDivOpacity > 1 ? 1 : darkDivOpacity < 0 ? 0 : darkDivOpacity
      setDarkDivOpacity(darkDivOpacity);
      
    });

    function setDarkDivOpacity(newOpacity) {
      document.getElementById('dark').style.opacity = newOpacity;
    }

    document.addEventListener('keydown', function (event) {

      // 0 to 9
      var index = ['Ã ', '&', 'Ã©', '"', "'", '(', '-', 'Ã¨', '_', 'Ã§'].indexOf(event.key)

      // Key 9 (Ã§) toggles local movie mode
      if (index === 9) {
        if (isLocalMovieMode) {
          stopMovieMode(); // Return to YouTube
        } else {
          isLocalMovieMode = true;
          player.pauseVideo(); // Pause YouTube before switching
          playMovieAtIndex(0); // Load first movie
        }
        return;
      }

      // Keys 1-8 play YouTube playlists - also exit movie mode if active
      if (index > 0 && index <= playlists.length) {
        if (isLocalMovieMode) {
          isLocalMovieMode = false;
          moviePlayer.pause();
          moviePlayer.style.display = 'none';
        }
      }
      
      playPlaylistIndex(index)

    });

    function playPlaylistIndex(index) {

      if (index <= 0 || index >= playlists.length + 1) return;

      channelsSelectorTimer = 2000

      console.info("playlist index to play", index)

      if (saveInterval) {
          clearInterval(saveInterval);
          saveInterval = null;
      }

      var playlistToLoad = playlists[index - 1];
      // Get the last viewed video id and current time for the selected playlist
      var lastPlaylistData = getLastPlaylistData(playlistToLoad.id);
      var lastVideoId = lastPlaylistData.videoId;
      var lastVideoIndex = lastPlaylistData.videoIndex || 0;
      var currentTime = lastPlaylistData.currentTime;

      var loadPlaylistParams = {
        listType: 'playlist',
        list: playlistToLoad.id,
        index: lastVideoIndex,
        startSeconds: currentTime
      }
      console.info(loadPlaylistParams)
      player.stopVideo()
      setTimeout(() => {
        player.loadPlaylist(loadPlaylistParams);
      }, 1000)


      document.body.focus();
    }

    var channelsSelector = document.getElementById('channels');
    var channelsSelectorTimer = 3000

    function startChannelsSelectorListening() {
      setInterval(() => {

        channels.classList.toggle('visible', channelsSelectorTimer > 0);

        document.querySelectorAll('#channels .channel').forEach(channel => {
          channel.classList.toggle(
            'current', 
            channel.classList.contains(player.getPlaylistId())
          );
        });

        channelsSelectorTimer -= 100
      }, 100)
    }

    // --- MOVIE PLAYER FUNCTIONS ---
    var moviePlayer = document.getElementById('movie-player');

    // Auto-replay movie when it ends
    moviePlayer.addEventListener('ended', function() {
      if (isLocalMovieMode && currentMovie) {
        moviePlayer.currentTime = 0;
        moviePlayer.play();
      }
    });

    function playMovieAtIndex(index) {
      if (index < 0 || index >= movies.length) return;

      var filename = movies[index];
      console.info("Loading movie:", filename);

      currentMovie = filename;
      
      if (saveInterval) {
          clearInterval(saveInterval);
          saveInterval = null;
      }

      // Disable YouTube player controls
      disableYouTubeControls();
      
      // Force YouTube to pause immediately
      if (player && typeof player.pauseVideo === 'function') {
        player.pauseVideo();
      }

      // Get last playback position for this movie
      var lastData = getLastMovieData(filename);
      var lastTime = lastData.currentTime || 0;

      // Set video source and load
      moviePlayer.src = 'movies/' + filename;
      moviePlayer.style.display = 'block';
      moviePlayer.currentTime = lastTime;
      moviePlayer.play();

      // Start auto-save interval
      saveInterval = setInterval(saveMovieProgress, 2500);
      
      // Keep YouTube paused while in movie mode
      var keepYouTubePausedInterval = setInterval(function() {
        if (!isLocalMovieMode) {
          clearInterval(keepYouTubePausedInterval);
          return;
        }
        if (player && typeof player.pauseVideo === 'function') {
          player.pauseVideo();
        }
      }, 500);

      document.body.focus();
    }

    function stopMovieMode() {
      console.info("Switching back to YouTube mode");
      isLocalMovieMode = false;
      currentMovie = null;
      moviePlayer.pause();
      moviePlayer.style.display = 'none';
      
      if (saveInterval) {
          clearInterval(saveInterval);
          saveInterval = null;
      }

      // Save movie progress before switching
      saveMovieProgress();
      
      // Re-enable YouTube player controls
      enableYouTubeControls();
      
      player.playVideo();
      document.body.focus();
    }
    
    
    createChannelsSelector()

    function createChannelsSelector() {
      var firstChannel = channelsSelector.querySelector('.channel');

      // Remove the initial channel from the DOM but keep a reference to clone later
      channelsSelector.removeChild(firstChannel);

      playlists.forEach(function (playlist) {
        // Clone the first channel element
        var newChannel = firstChannel.cloneNode(true);

        newChannel.classList.add(playlist.id)
        // Update the src attribute of the img tag
        var imgTag = newChannel.querySelector('img');
        imgTag.src = 'logos/' + playlist.logo;

        // Append the new channel to the container
          channelsSelector.appendChild(newChannel);
      });
    }

    function setTvPower(on) {
      
      fetch(`http://192.168.1.19/rpc/Switch.Set?id=0&on=${on}`)
        .then(r => r.json())
        .then(console.log)
        .catch(err => console.warn('setTvPower error', err));
    }

  </script>

</body>

</html>